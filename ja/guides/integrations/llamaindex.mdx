# LlamaIndex

Weaveã¯[LlamaIndex Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://github.com/run-llama/llama_index)ã‚’é€šã˜ã¦è¡Œã‚ã‚Œã‚‹ã™ã¹ã¦ã®å‘¼ã³å‡ºã—ã®è¿½è·¡ã¨ãƒ­ã‚°è¨˜éŒ²ã‚’ç°¡ç´ åŒ–ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

LLMã‚’æ‰±ã†éš›ã€ãƒ‡ãƒãƒƒã‚°ã¯é¿ã‘ã‚‰ã‚Œã¾ã›ã‚“ã€‚ãƒ¢ãƒ‡ãƒ«å‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ãŸã‚Šã€å‡ºåŠ›ã®å½¢å¼ãŒé–“é•ã£ã¦ã„ãŸã‚Šã€ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«å‘¼ã³å‡ºã—ãŒæ··ä¹±ã‚’æ‹›ã„ãŸã‚Šã™ã‚‹å ´åˆã€å•é¡Œã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã¯é›£ã—ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚[LlamaIndex](https://docs.llamaindex.ai/en/stable/)ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å¤šãã®å ´åˆã€è¤‡æ•°ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨LLMå‘¼ã³å‡ºã—ã§æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ãƒã‚§ãƒ¼ãƒ³ã‚„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å†…éƒ¨å‹•ä½œã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

Weaveã¯ã€LlamaIndexã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã“ã¨ã§ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç°¡ç´ åŒ–ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç›£è¦–ãŠã‚ˆã³åˆ†æã—ã€LLMãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°ã¨æœ€é©åŒ–ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚Weaveã¯è©•ä¾¡ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚‚å½¹ç«‹ã¡ã¾ã™ã€‚

## ã¯ã˜ã‚ã«

é–‹å§‹ã™ã‚‹ã«ã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å…ˆé ­ã§å˜ã«`weave.init()`ã‚’å‘¼ã³å‡ºã™ã ã‘ã§ã™ã€‚`weave.init()`ã®å¼•æ•°ã¯ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æ•´ç†ã™ã‚‹ã®ã«å½¹ç«‹ã¤ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã§ã™ã€‚

```python
import weave
from llama_index.core.chat_engine import SimpleChatEngine

# Initialize Weave with your project name
# highlight-next-line
weave.init("llamaindex_demo")

chat_engine = SimpleChatEngine.from_defaults()
response = chat_engine.chat(
    "Say something profound and romantic about fourth of July"
)
print(response)
```

ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€å†…éƒ¨ã§OpenAIå‘¼ã³å‡ºã—ã‚’è¡Œã†å˜ç´”ãªLlamaIndexãƒãƒ£ãƒƒãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ã”è¦§ãã ã•ã„ï¼š

[![simple\_llamaindex.png](imgs/simple_llamaindex.png)](https://wandb.ai/wandbot/test-llamaindex-weave/weave/calls/b6b5d898-2df8-4e14-b553-66ce84661e74)

## ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°

LlamaIndexã¯ã€ãƒ‡ãƒ¼ã‚¿ã¨LLMã‚’ç°¡å˜ã«æ¥ç¶šã§ãã‚‹ã“ã¨ã§çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚å˜ç´”ãªRAGã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€åŸ‹ã‚è¾¼ã¿ã‚¹ãƒ†ãƒƒãƒ—ã€æ¤œç´¢ã‚¹ãƒ†ãƒƒãƒ—ã€å¿œç­”åˆæˆã‚¹ãƒ†ãƒƒãƒ—ãŒå¿…è¦ã§ã™ã€‚è¤‡é›‘ã•ãŒå¢—ã™ã«ã¤ã‚Œã¦ã€é–‹ç™ºä¸­ã‚‚æœ¬ç•ªç’°å¢ƒã§ã‚‚å€‹ã€…ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ä¸­å¤®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã“ã¨ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒãƒƒã‚°ã¨æ”¹å–„ã«ä¸å¯æ¬ ã§ã™ã€‚Weaveã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€LLMå‘¼ã³å‡ºã—ã€ãƒ„ãƒ¼ãƒ«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¹ãƒ†ãƒƒãƒ—ãªã©ã€LlamaIndexãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é€šã˜ã¦è¡Œã‚ã‚Œã‚‹ã™ã¹ã¦ã®å‘¼ã³å‡ºã—ã‚’è‡ªå‹•çš„ã«è¿½è·¡ã—ã¾ã™ã€‚Weaveã‚¦ã‚§ãƒ–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯LlamaIndexã®[Starter Tutorial (OpenAI)](https://docs.llamaindex.ai/en/stable/getting_started/starter_example/)ã‹ã‚‰ã®å˜ç´”ãªRAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¾‹ã§ã™ï¼š

```python
import weave
from llama_index.core import VectorStoreIndex, SimpleDirectoryReader

# Initialize Weave with your project name
# highlight-next-line
weave.init("llamaindex_demo")

# Assuming you have a `.txt` file in the `data` directory
documents = SimpleDirectoryReader("data").load_data()
index = VectorStoreIndex.from_documents(documents)

query_engine = index.as_query_engine()
response = query_engine.query("What did the author do growing up?")
print(response)
```

ãƒˆãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯ã€Œã‚¤ãƒ™ãƒ³ãƒˆã€ã ã‘ã§ãªãã€å®Ÿè¡Œæ™‚é–“ã€ã‚³ã‚¹ãƒˆã€è©²å½“ã™ã‚‹å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚‚è¨˜éŒ²ã—ã¾ã™ã€‚å„ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ã¨å‡ºåŠ›ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æ˜ã‚Šä¸‹ã’ã¦ãã ã•ã„ã€‚

[![llamaindex\_rag.png](imgs/llamaindex_rag.png)](https://wandb.ai/wandbot/test-llamaindex-weave/weave/calls?filter=%7B%22traceRootsOnly%22%3Atrue%7D\&peekPath=%2Fwandbot%2Ftest-llamaindex-weave%2Fcalls%2F6ac53407-1bb7-4c38-b5a3-c302bd877a11%3Ftracetree%3D1)

## ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯è¦³æ¸¬æ€§ ğŸ”­

LlamaIndexã¯[one-click observability ğŸ”­](https://docs.llamaindex.ai/en/stable/module_guides/observability/)ã‚’æä¾›ã—ã€æœ¬ç•ªç’°å¢ƒã§åŸå‰‡ã«åŸºã¥ã„ãŸLLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ç§ãŸã¡ã®çµ±åˆã¯LlamaIndexã®ã“ã®æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã€è‡ªå‹•çš„ã«[`WeaveCallbackHandler()`](https://github.com/wandb/weave/blob/master/weave/integrations/llamaindex/llamaindex.py)ã‚’`llama_index.core.global_handler`ã«è¨­å®šã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€LlamaIndexã¨Weaveã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã€ã‚ãªãŸãŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯Weaveãƒ©ãƒ³ã‚’åˆæœŸåŒ–ã™ã‚‹ã“ã¨ã ã‘ã§ã™ - `weave.init(<name-of-project>)`

## ä½œæˆã™ã‚‹`Model`ã‚ˆã‚Šç°¡å˜ãªå®Ÿé¨“ã®ãŸã‚ã«

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ãƒ¢ãƒ‡ãƒ«æ§‹æˆã€æ¨è«–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã€è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã¤ã•ã¾ã–ã¾ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§LLMã‚’æ•´ç†ãŠã‚ˆã³è©•ä¾¡ã™ã‚‹ã“ã¨ã¯é›£ã—ã„ã§ã™ã€‚[`weave.Model`](/ja/guides/core-types/models)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ãªã©ã®å®Ÿé¨“ã®è©³ç´°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦æ•´ç†ã—ã€ç•°ãªã‚‹ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¯”è¼ƒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

æ¬¡ã®ä¾‹ã¯ã€`WeaveModel`ã§LlamaIndexã‚¯ã‚¨ãƒªã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚[weave/data](https://github.com/wandb/weave/tree/master/data) folder:

```python
import weave

from llama_index.core import VectorStoreIndex, SimpleDirectoryReader
from llama_index.core.node_parser import SentenceSplitter
from llama_index.llms.openai import OpenAI
from llama_index.core import PromptTemplate


PROMPT_TEMPLATE = """
You are given with relevant information about Paul Graham. Answer the user query only based on the information provided. Don't make up stuff.

User Query: {query_str}
Context: {context_str}
Answer:
"""

# highlight-next-line
class SimpleRAGPipeline(weave.Model):
    chat_llm: str = "gpt-4"
    temperature: float = 0.1
    similarity_top_k: int = 2
    chunk_size: int = 256
    chunk_overlap: int = 20
    prompt_template: str = PROMPT_TEMPLATE

    def get_llm(self):
        return OpenAI(temperature=self.temperature, model=self.chat_llm)

    def get_template(self):
        return PromptTemplate(self.prompt_template)

    def load_documents_and_chunk(self, data):
        documents = SimpleDirectoryReader(data).load_data()
        splitter = SentenceSplitter(
            chunk_size=self.chunk_size,
            chunk_overlap=self.chunk_overlap,
        )
        nodes = splitter.get_nodes_from_documents(documents)
        return nodes

    def get_query_engine(self, data):
        nodes = self.load_documents_and_chunk(data)
        index = VectorStoreIndex(nodes)

        llm = self.get_llm()
        prompt_template = self.get_template()

        return index.as_query_engine(
            similarity_top_k=self.similarity_top_k,
            llm=llm,
            text_qa_template=prompt_template,
        )

# highlight-next-line
    @weave.op()
    def predict(self, query: str):
        query_engine = self.get_query_engine(
            # This data can be found in the weave repo under data/paul_graham
            "data/paul_graham",
        )
        response = query_engine.query(query)
        return {"response": response.response}

# highlight-next-line
weave.init("test-llamaindex-weave")

rag_pipeline = SimpleRAGPipeline()
response = rag_pipeline.predict("What did the author do growing up?")
print(response)
```

ã“ã®`SimpleRAGPipeline`ã‚¯ãƒ©ã‚¹ã¯`weave.Model`ã‹ã‚‰ã‚µãƒ–ã‚¯ãƒ©ã‚¹åŒ–ã•ã‚Œã€ã“ã®RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®é‡è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ•´ç†ã—ã¾ã™ã€‚`query`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’`weave.op()` ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

[![llamaindex\_model.png](imgs/llamaindex_model.png)](https://wandb.ai/wandbot/test-llamaindex-weave/weave/calls?filter=%7B%22traceRootsOnly%22%3Atrue%7D\&peekPath=%2Fwandbot%2Ftest-llamaindex-weave%2Fcalls%2Fa82afbf4-29a5-43cd-8c51-603350abeafd%3Ftracetree%3D1)

## è©•ä¾¡ã®å®Ÿæ–½ `weave.Evaluation`

è©•ä¾¡ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®šã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚[`weave.Evaluation`](/ja/guides/core-types/evaluations) ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ¢ãƒ‡ãƒ«ãŒç‰¹å®šã®ã‚¿ã‚¹ã‚¯ã‚„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã©ã‚Œã ã‘ã†ã¾ãæ©Ÿèƒ½ã™ã‚‹ã‹ã‚’æŠŠæ¡ã§ãã€ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åå¾©ã‚’æ¯”è¼ƒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š

```python
import asyncio
from llama_index.core.evaluation import CorrectnessEvaluator

eval_examples = [
    {
        "id": "0",
        "query": "What programming language did Paul Graham learn to teach himself AI when he was in college?",
        "ground_truth": "Paul Graham learned Lisp to teach himself AI when he was in college.",
    },
    {
        "id": "1",
        "query": "What was the name of the startup Paul Graham co-founded that was eventually acquired by Yahoo?",
        "ground_truth": "The startup Paul Graham co-founded that was eventually acquired by Yahoo was called Viaweb.",
    },
    {
        "id": "2",
        "query": "What is the capital city of France?",
        "ground_truth": "I cannot answer this question because no information was provided in the text.",
    },
]

llm_judge = OpenAI(model="gpt-4", temperature=0.0)
evaluator = CorrectnessEvaluator(llm=llm_judge)

# highlight-next-line
@weave.op()
def correctness_evaluator(query: str, ground_truth: str, output: dict):
    result = evaluator.evaluate(
        query=query, reference=ground_truth, response=output["response"]
    )
    return {"correctness": float(result.score)}

# highlight-next-line
evaluation = weave.Evaluation(dataset=eval_examples, scorers=[correctness_evaluator])

rag_pipeline = SimpleRAGPipeline()

# highlight-next-line
asyncio.run(evaluation.evaluate(rag_pipeline))
```

ã“ã®è©•ä¾¡ã¯å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¾‹ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚`weave.Evaluation` ã‚’ä½¿ç”¨ã—ãŸè©•ä¾¡ã«ã¯ã€è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã€ã‚¹ã‚³ã‚¢ãƒ©ãƒ¼é–¢æ•°ã€ãŠã‚ˆã³ `weave.Model` ãŒå¿…è¦ã§ã™ã€‚3ã¤ã®ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¤ã„ã¦ã„ãã¤ã‹ã®æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

* è©•ä¾¡ã‚µãƒ³ãƒ—ãƒ«è¾æ›¸ã®ã‚­ãƒ¼ãŒã‚¹ã‚³ã‚¢ãƒ©ãƒ¼é–¢æ•°ã®å¼•æ•°ãŠã‚ˆã³ `weave.Model` ã® `predict` ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
* `weave.Model` ã«ã¯ `predict` ã¾ãŸã¯ `infer` ã¾ãŸã¯ `forward` ã¨ã„ã†åå‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¿…è¦ã§ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ `weave.op()` ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã®ãŸã‚ã®è£…é£¾ã‚’ã—ã¦ãã ã•ã„ã€‚
* ã‚¹ã‚³ã‚¢ãƒ©ãƒ¼é–¢æ•°ã¯ `weave.op()` ã§è£…é£¾ã•ã‚Œã€`output` ã‚’åå‰ä»˜ãå¼•æ•°ã¨ã—ã¦æŒã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[![llamaindex\_evaluation.png](imgs/llamaindex_evaluation.png)](https://wandb.ai/wandbot/llamaindex-weave/weave/calls?filter=%7B%22opVersionRefs%22%3A%5B%22weave%3A%2F%2F%2Fwandbot%2Fllamaindex-weave%2Fop%2FEvaluation.predict_and_score%3ANmwfShfFmgAhDGLXrF6Xn02T9MIAsCXBUcifCjyKpOM%22%5D%2C%22parentId%22%3A%2233491e66-b580-47fa-9d43-0cd6f1dc572a%22%7D\&peekPath=%2Fwandbot%2Fllamaindex-weave%2Fcalls%2F33491e66-b580-47fa-9d43-0cd6f1dc572a%3Ftracetree%3D1)

Weaveã¨LlamaIndexã‚’çµ±åˆã™ã‚‹ã“ã¨ã§ã€LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŒ…æ‹¬çš„ãªãƒ­ã‚®ãƒ³ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’ç¢ºä¿ã—ã€è©•ä¾¡ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒãƒƒã‚°ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚’å®¹æ˜“ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
