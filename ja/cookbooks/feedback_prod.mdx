---
- title: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³
- description: W&B Weaveã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’å­¦ã¶
---

<Note>
  ã“ã‚Œã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

  * [Open in Google Colab](https://colab.research.google.com/github/wandb/weave/blob/master/docs/notebooks/feedback_prod.ipynb)
  * [View source on GitHub](https://github.com/wandb/weave/blob/master/docs/notebooks/feedback_prod.ipynb)
</Note>

##

ç”Ÿæˆã•ã‚ŒãŸLLMãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è‡ªå‹•çš„ã«è©•ä¾¡ã™ã‚‹ã“ã¨ã¯é›£ã—ã„ã“ã¨ãŒå¤šã„ãŸã‚ã€ãƒªã‚¹ã‚¯è¨±å®¹åº¦ã«å¿œã˜ã¦ã€ç›´æ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ã—ã¦æ”¹å–„ã™ã¹ãé ˜åŸŸã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
Streamlitã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã—ã€LLMã®å¯¾è©±ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’Weaveã§è¨˜éŒ²ã—ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```python
!pip install weave openai streamlit wandb
!pip install set-env-colab-kaggle-dotenv -q # for env var
python
# Add a .env file with your OpenAI and WandB API keys
from set_env import set_env

_ = set_env("OPENAI_API_KEY")
_ = set_env("WANDB_API_KEY")
```

æ¬¡ã«ã€`chatbot.py`ã¨ã„ã†åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ï¼š

```python
# chatbot.py

import openai
import streamlit as st
import wandb
from set_env import set_env

import weave

_ = set_env("OPENAI_API_KEY")
_ = set_env("WANDB_API_KEY")

# highlight-next-line
wandb.login()

# highlight-next-line
weave_client = weave.init("feedback-example")
oai_client = openai.OpenAI()

def init_states():
    """Set up session_state keys if they don't exist yet."""
    if "messages" not in st.session_state:
        st.session_state["messages"] = []
    if "calls" not in st.session_state:
        st.session_state["calls"] = []
    if "session_id" not in st.session_state:
        st.session_state["session_id"] = "123abc"

# highlight-next-line
@weave.op
def chat_response(full_history):
    """
    Calls the OpenAI API in streaming mode given the entire conversation history so far.
    full_history is a list of dicts: [{"role":"user"|"assistant","content":...}, ...]
    """
    stream = oai_client.chat.completions.create(
        model="gpt-4", messages=full_history, stream=True
    )
    response_text = st.write_stream(stream)
    return {"response": response_text}

def render_feedback_buttons(call_idx):
    """Renders thumbs up/down and text feedback for the call."""
    col1, col2, col3 = st.columns([1, 1, 4])

    # Thumbs up button
    with col1:
        if st.button("ğŸ‘", key=f"thumbs_up_{call_idx}"):
            st.session_state.calls[call_idx].feedback.add_reaction("ğŸ‘")
            st.success("Thanks for the feedback!")

    # Thumbs down button
    with col2:
        if st.button("ğŸ‘", key=f"thumbs_down_{call_idx}"):
            st.session_state.calls[call_idx].feedback.add_reaction("ğŸ‘")
            st.success("Thanks for the feedback!")

    # Text feedback
    with col3:
        feedback_text = st.text_input("Feedback", key=f"feedback_input_{call_idx}")
        if (
            st.button("Submit Feedback", key=f"submit_feedback_{call_idx}")
            and feedback_text
        ):
            st.session_state.calls[call_idx].feedback.add_note(feedback_text)
            st.success("Feedback submitted!")

def display_old_messages():
    """Displays the conversation stored in st.session_state.messages with feedback buttons"""
    for idx, message in enumerate(st.session_state.messages):
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

            # If it's an assistant message, show feedback form
            if message["role"] == "assistant":
                # Figure out index of this assistant message in st.session_state.calls
                assistant_idx = (
                    len(
                        [
                            m
                            for m in st.session_state.messages[: idx + 1]
                            if m["role"] == "assistant"
                        ]
                    )
                    - 1
                )
                # Render thumbs up/down & text feedback
                if assistant_idx < len(st.session_state.calls):
                    render_feedback_buttons(assistant_idx)

def display_chat_prompt():
    """Displays the chat prompt input box."""
    if prompt := st.chat_input("Ask me anything!"):
        # Immediately render new user message
        with st.chat_message("user"):
            st.markdown(prompt)

        # Save user message in session
        st.session_state.messages.append({"role": "user", "content": prompt})

        # Prepare chat history for the API
        full_history = [
            {"role": msg["role"], "content": msg["content"]}
            for msg in st.session_state.messages
        ]

        with st.chat_message("assistant"):
            # Attach Weave attributes for tracking of conversation instances
            with weave.attributes(
                {"session": st.session_state["session_id"], "env": "prod"}
            ):
                # Call the OpenAI API (stream)
                result, call = chat_response.call(full_history)

                # Store the assistant message
                st.session_state.messages.append(
                    {"role": "assistant", "content": result["response"]}
                )

                # Store the weave call object to link feedback to the specific response
                st.session_state.calls.append(call)

                # Render feedback buttons for the new message
                new_assistant_idx = (
                    len(
                        [
                            m
                            for m in st.session_state.messages
                            if m["role"] == "assistant"
                        ]
                    )
                    - 1
                )

                # Render feedback buttons
                if new_assistant_idx < len(st.session_state.calls):
                    render_feedback_buttons(new_assistant_idx)

def main():
    st.title("Chatbot with immediate feedback forms")
    init_states()
    display_old_messages()
    display_chat_prompt()

if __name__ == "__main__":
    main()
```

ã“ã‚Œã‚’`streamlit run chatbot.py`ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

ã“ã‚Œã§ã€ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨å¯¾è©±ã—ã€å„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¾Œã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãã¾ã™ã€‚
Weave UIã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€æ·»ä»˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## èª¬æ˜

ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã•ã‚ŒãŸäºˆæ¸¬é–¢æ•°ã‚’æ¬¡ã®ã‚ˆã†ã«è€ƒãˆã‚‹ã¨ï¼š

```python
import weave

weave.init("feedback-example")

# highlight-next-line
@weave.op
def predict(input_data):
    # Your prediction logic here
    some_result = "hello world"
    return some_result
```

é€šå¸¸é€šã‚Šã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¢ãƒ‡ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æä¾›ã§ãã¾ã™ï¼š

```python
with weave.attributes(
    {"session": "123abc", "env": "prod"}
):  # attach arbitrary attributes to the call alongside inputs & outputs
    result = predict(input_data="your data here")  # user question through the App UI
```

ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ·»ä»˜ã™ã‚‹ã«ã¯ã€`call`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯`.call()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦*é€šå¸¸ã®é–¢æ•°å‘¼ã³å‡ºã—ã®ä»£ã‚ã‚Šã«*å–å¾—ã—ã¾ã™ï¼š

```python
result, call = predict.call(input_data="your data here")
```

ã“ã®ã‚³ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ç‰¹å®šã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ·»ä»˜ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
å‘¼ã³å‡ºã—ã‚’è¡Œã£ãŸå¾Œã€æ“ä½œã®å‡ºåŠ›ã¯`result`ã‚’ä½¿ç”¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚

```python
call.feedback.add_reaction("ğŸ‘")  # user reaction through the App UI
```

## çµè«–

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Streamlitã‚’ä½¿ç”¨ã—ã¦ãƒãƒ£ãƒƒãƒˆUIã‚’æ§‹ç¯‰ã—ã€å…¥å‡ºåŠ›ã‚’Weaveã§è¨˜éŒ²ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ã™ã‚‹ãŸã‚ã®ğŸ‘ğŸ‘ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
